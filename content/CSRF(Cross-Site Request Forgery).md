## 소개

**CSRF(Cross-Site Request Forgery)** 는 사용자와 서버 간의 신뢰 관계를 악용하여 발생하는 대표적인 웹 공격입니다. 이 글에서는 CSRF의 개념과 동작 방식, 그리고 이를 방어하기 위한 다양한 기법에 대해 자세히 알아보겠습니다.

---

## CSRF란 무엇인가?

**CSRF**는 한국어로 **교차 사이트 요청 위조**라고 하며, 인증된 사용자의 세션을 이용하여 의도치 않은 요청을 서버에 보내는 공격 기법입니다. 공격자는 사용자가 신뢰하는 웹 사이트로 위조된 요청을 전송하여 사용자 권한으로 악의적인 동작을 수행하게 합니다.

---

## CSRF 공격의 동작 원리

1. **사용자 인증**: 사용자가 웹 애플리케이션에 로그인하여 세션을 유지합니다.
2. **악의적인 사이트 방문**: 사용자가 공격자가 만든 악성 웹 페이지를 방문합니다.
3. **위조된 요청 전송**: 그 페이지에서 사용자의 브라우저를 통해 위조된 요청이 자동으로 전송됩니다.
4. **서버 처리**: 서버는 해당 요청이 인증된 사용자로부터 온 것으로 인식하고 처리합니다.

---

## CSRF 공격의 예시

예를 들어, 은행 웹 사이트에서 송금 기능이 있다고 가정합니다. 공격자는 다음과 같은 이미지 태그를 포함한 웹 페이지를 제작합니다.

```html
<img src="https://bank.example.com/transfer?amount=1000&to=attacker_account" style="display:none;">
```

사용자가 이 페이지를 방문하면 브라우저는 자동으로 해당 이미지를 로드하려고 시도하며, 그 과정에서 은행 서버로 GET 요청이 전송됩니다. 만약 사용자가 은행 사이트에 로그인되어 있다면, 이 요청은 인증된 상태로 처리되어 공격자의 계좌로 돈이 이체될 수 있습니다.

---

## CSRF 방어 방법

### 1. CSRF 토큰 사용

서버는 사용자 세션마다 고유한 토큰을 생성하여 폼에 포함시킵니다. 서버는 요청을 받을 때 이 토큰의 유효성을 검사하여 위조된 요청인지 확인합니다.

```html
<input type="hidden" name="csrf_token" value="abcdef1234567890">
```

### 2. SameSite 쿠키 속성 설정

쿠키에 `SameSite` 속성을 설정하여 크로스 사이트에서 쿠키가 전송되지 않도록 합니다.

- **Strict**: 완전히 다른 사이트에서의 요청에 쿠키가 전송되지 않습니다.
- **Lax**: 일부 안전한 경우에만 쿠키가 전송됩니다.

```http
Set-Cookie: sessionid=abcdef1234567890; SameSite=Strict; Secure
```

### 3. Referer 헤더 검증

요청의 `Referer` 헤더를 검사하여 요청이 신뢰할 수 있는 도메인에서 왔는지 확인합니다. 하지만 `Referer` 헤더는 숨길 수 있으므로 보조적인 방어 기법으로 사용합니다.

### 4. 사용자 입력 재인증

중요한 요청에 대해서는 사용자의 재인증을 요구합니다. 예를 들어 비밀번호를 다시 입력하도록 하여 의도치 않은 요청을 방지합니다.

### 5. CAPTCHA 사용

봇이나 자동화된 공격을 방지하기 위해 CAPTCHA를 도입합니다. 하지만 사용자 경험을 저해할 수 있으므로 신중히 고려해야 합니다.

---

## CSRF 방어를 위한 모범 사례

- **GET 요청은 안전하게**: GET 요청은 데이터 변경이 아닌 데이터 조회에만 사용하고, 상태 변경은 POST, PUT, DELETE 등의 메소드를 사용합니다.
- **콘텐츠 보안 정책(CSP) 적용**: CSP를 통해 외부 스크립트 로딩을 제한하여 악의적인 스크립트 실행을 방지합니다.
- **프레임워크의 보안 기능 활용**: 대부분의 웹 프레임워크는 CSRF 방어 기능을 제공합니다. 이를 적극 활용하여 보안을 강화합니다.

---

## 결론

CSRF는 사용자와 서버 간의 신뢰 관계를 악용하는 치명적인 공격입니다. 하지만 올바른 방어 기법을 적용한다면 충분히 예방할 수 있습니다. 개발자는 항상 보안에 대한 인식을 높이고, 최신 보안 동향을 파악하여 안전한 웹 애플리케이션을 제공해야 합니다.

---

## 참고 자료

- [OWASP CSRF 방지](https://owasp.org/www-community/attacks/csrf)
- [MDN Web Docs - SameSite 쿠키](https://developer.mozilla.org/ko/docs/Web/HTTP/Headers/Set-Cookie/SameSite)
- [위키백과 - 크로스 사이트 요청 위조](https://ko.wikipedia.org/wiki/크로스_사이트_요청_위조)